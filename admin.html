<!doctype html><html><head>
  <meta charset="utf-8">
  <title>Voices of the Land — Admin Review</title>
  <meta name="viewport" content="width=device-width,initial-scale:1" />
  <style>
    :root{--bg:#f5efe6;--card:#fff9f2;--accent:#8a4b2a;--accent-2:#b33a2a;--muted:#6b5847;}
    body{font-family:Inter, Arial, sans-serif;background:var(--bg);color:var(--muted);padding:20px;margin:0;}
    /* Hide the main content by default */
    .wrap{max-width:920px;margin:0 auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.05); display: none;}
    h1{color:var(--accent);margin:0 0 8px}
    .entry{border:1px solid #e6dcd1;padding:12px;border-radius:8px;margin-bottom:10px}
    button{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    button:disabled{background-color:#ccc;cursor:not-allowed;}
    .secondary{background:transparent;color:var(--accent);border:1px solid var(--accent)}
    .main-nav{background-color:var(--accent);border-radius:8px;margin-bottom:20px;overflow:hidden;}
    .main-nav ul{list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;justify-content:center;}
    .main-nav a{display:block;padding:12px 18px;text-decoration:none;color:white;font-weight:600;font-size:15px;}
    .main-nav a:hover{background-color:var(--accent-2);}
    #error-message{text-align:center;font-size:18px;font-weight:600;color:var(--accent-2);display:none;}
  </style></head><body>
  
  <div class="wrap" id="mainContent">
    <nav class="main-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="submit.html">Submit a Word</a></li>
        <li><a href="dictionary.html">Public Dictionary</a></li>
        <li><a href="admin.html">Admin Review</a></li>
      </ul>
    </nav>
    
    <h1>Pending Submissions — Elder Review</h1>
    <p class="muted">Use this page to verify entries. Marking "Verified" publishes the item to the public dictionary in real-time.</p>
    <div id="list">Loading...</div>
  </div>

  <div id="errorMessage">Access Denied.</div>

  <!-- Import Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    let db, auth;
    let wordsCollection;
    const container = document.getElementById('list');

    // --- Initialization & Password ---
    async function initialize() {
      try {
        setLogLevel('debug');
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // Sign in the user
        if (authToken) {
          await signInWithCustomToken(auth, authToken);
        } else {
          await signInAnonymously(auth);
        }
        
        // Define the public collection path
        wordsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'words');
        
        // Password check
        checkPassword();

      } catch (e) {
        console.error("Firebase Init Error:", e);
        document.getElementById('errorMessage').textContent = "Error: Could not connect to database.";
        document.getElementById('errorMessage').style.display = 'block';
      }
    }
    
    // --- PASSWORD FUNCTION ---
    function checkPassword() {
      const PASSWORD = "CreeAdmin2025"; 
      const entry = prompt("Please enter the Admin Password:");
      if (entry === PASSWORD) {
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
        loadPending(); // Load data only if password is correct
      } else {
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('errorMessage').textContent = "Access Denied.";
        document.getElementById('errorMessage').style.display = 'block';
      }
    }
    // --- END FUNCTION ---

    // --- Load Pending Words ---
    function loadPending() {
      // Create a query to get only UNVERIFIED words
      const q = query(wordsCollection, where("verified", "==", false));

      onSnapshot(q, (querySnapshot) => {
        if (querySnapshot.empty) {
          container.innerHTML = "<p>No pending submissions.</p>";
          return;
        }

        container.innerHTML = ""; // Clear the list
        
        querySnapshot.forEach((doc) => {
          const e = doc.data(); // e is the word data
          const docId = doc.id;  // docId is the unique ID of the document
          
          const div = document.createElement('div');
          div.className = "entry";
          const timestamp = e.createdAt ? new Date(e.createdAt.seconds * 1000).toLocaleString() : 'Unknown date';
          
          div.innerHTML = `
            <div style="font-weight:700">${e.indigenousText}</div>
            <div style="margin-top:4px"><b>English:</b> ${e.englishText}</div>
            ${e.frenchText ? `<div style="margin-top:4px"><b>French:</b> ${e.frenchText}</div>` : ""}
            <div style="margin-top:6px; font-size: 14px;">Community: ${e.community || "Cree"} • Submitted by: ${e.submitterName || "Anonymous"} • ${timestamp}</div>
            ${e.notes ? `<div style="margin-top:8px">Notes: ${e.notes}</div>` : ""}
            <div style="margin-top:10px">
              <button class="verify-btn" data-id="${docId}">Verify (publish)</button>
            </div>`;
          
          container.appendChild(div);
        });

        // Add event listeners to all new buttons
        container.querySelectorAll('.verify-btn').forEach(b => {
          b.onclick = async () => {
            const isConfirmed = confirm("Are you sure you want to verify and publish this entry?");
            if (!isConfirmed) { return; }

            const docIdToVerify = b.getAttribute('data-id');
            b.disabled = true;
            b.textContent = "Verifying...";

            try {
              // Get a reference to the specific document
              const docRef = doc(wordsCollection, docIdToVerify);
              
              // Update the 'verified' field to true
              await updateDoc(docRef, {
                verified: true
              });
              
              // The onSnapshot listener will automatically remove the item from the list!
              
            } catch (err) {
              console.error("Error verifying document: ", err);
              alert("Error verifying. Please try again.");
              b.disabled = false;
              b.textContent = "Verify (publish)";
            }
          };
        });

      }, (error) => {
        console.error("Error loading pending submissions: ", error);
        container.innerHTML = "<p>Error loading pending submissions. Please try again.</p>";
      });
    }

    // Run the app
    initialize();
  </script>
</body></html>
