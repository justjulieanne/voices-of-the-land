// --- Clear button ---
document.getElementById('clearBtn').onclick = () => {
  document.getElementById('submitter').value = "";
  document.getElementById('indigenousText').value = "";
  document.getElementById('syllabicsText').value = "";
  document.getElementById('englishText').value = "";
  document.getElementById('frenchText').value = "";
  document.getElementById('pronunciation').value = "";
  document.getElementById('notes').value = "";
  player.src = ""; 
  player.style.display = "none";
  window._latestBlob = null;
  recStatus.textContent = "";
  document.getElementById('consent').checked = false;
  resultEl.textContent = "";
  resultEl.classList.remove('error');
};

// --- Submit button ---
submitBtn.onclick = async () => {
  const submitter = document.getElementById('submitter').value.trim();
  const community = document.getElementById('community').value;
  const indigenousText = document.getElementById('indigenousText').value.trim();
  const syllabicsText = document.getElementById('syllabicsText').value.trim();
  const englishText = document.getElementById('englishText').value.trim();
  const frenchText = document.getElementById('frenchText').value.trim();
  const pronunciation = document.getElementById('pronunciation').value.trim();
  const notes = document.getElementById('notes').value.trim();
  const consent = document.getElementById('consent').checked;

  if (!indigenousText || !englishText) {
    resultEl.textContent = "Error: Please provide at least Cree text and English translation.";
    resultEl.classList.add('error');
    return;
  }
  if (!consent) {
    resultEl.textContent = "Error: Please check the consent box before submitting.";
    resultEl.classList.add('error');
    return;
  }

  let audioBase64 = null;
  if (window._latestBlob) {
    const arrBuffer = await window._latestBlob.arrayBuffer();
    const bytes = new Uint8Array(arrBuffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
    audioBase64 = btoa(binary);
  }

  const payload = {
    action: "submit",
    community,
    submitter,
    indigenousText,
    syllabicsText,
    englishText,
    frenchText,
    pronunciation,
    notes,
    consent: consent,
    audioBase64,
    audioMime: audioBase64 ? audioMime : null
  };

  submitBtn.disabled = true;
  resultEl.textContent = "Submitting...";
  resultEl.classList.remove('error');

  try {
    const resp = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: {"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload)
    });

    if (!resp.ok) throw new Error(`HTTP error! Status: ${resp.status}`);
    const j = await resp.json();

    if (j.success) {
      resultEl.textContent = "Submitted â€” thank you. It will be verified by Elders before publication.";
      document.getElementById('clearBtn').click();
    } else {
      resultEl.textContent = "Error: " + (j.message || JSON.stringify(j));
      resultEl.classList.add('error');
    }
  } catch (err) {
    console.error("Fetch Error:", err);
    resultEl.textContent = `Submission failed. Please check your internet connection. (Error: ${err.message})`;
    resultEl.classList.add('error');
  } finally {
    submitBtn.disabled = false;
  }
};
